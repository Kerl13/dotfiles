#!/bin/sh

set -euC

# The global state is stored in $RUNTIME_VAR.
# Do not edit this file manually

RUNTIME_DIR="$HOME/.local/var/lib"
RUNTIME_VAR="$RUNTIME_DIR/xkb_current"

# Library functions

set_xkb_pref () {
  setxkbmap fr oss
  setxkbmap -option  # reset all options
  killall xcape 2>/dev/null || true
  case "$1" in
    "custom")
      setxkbmap -option 'ctrl:nocaps'
      xcape -t 300 -e 'Control_L=Escape'
      # Shift+! = \
      xmodmap -e 'keycode 61 = exclam backslash exclam backslash exclamdown U2212 exclamdown U2212'
      # Tab+hjkl = arrow keys
      xmodmap -e 'keycode 23 = Mode_switch ISO_Left_Tab Tab ISO_Left_Tab Tab ISO_Left_Tab'
      xmodmap -e 'keycode any = Tab'
      xcape -t 300 -e 'Mode_switch=Tab'
      xmodmap -e 'keycode  43 = h H Left H eth ETH eth ETH'
      xmodmap -e 'keycode  44 = j J Down J udiaeresis Udiaeresis udiaeresis Udiaeresis'
      xmodmap -e 'keycode  45 = k K Up K idiaeresis Idiaeresis idiaeresis Idiaeresis'
      xmodmap -e 'keycode  46 = l L Right L U0140 U013F U0140 U013F'
      ;;
    "fr oss")
      ;;
    "*")
      echo "Invalid xkb_pref: $1"
      exit 1
  esac
  mkdir -p "$RUNTIME_DIR"
  echo "$1" >| "$RUNTIME_VAR"
  echo "Keyboard layout set to '$1'"
}

get_xkb_pref () {
  if [ -f "$RUNTIME_VAR" ]; then
    cat "$RUNTIME_VAR"
  else
    echo "undef"
  fi
}

next_xkb_pref () {
  case "$(get_xkb_pref)" in
    "custom") echo "fr oss" ;;
    "fr oss") echo "custom" ;;
    "*") echo "custom";;
  esac
}

toggle_xkb_pref () {
  set_xkb_pref "$(next_xkb_pref "$(get_xkb_pref)")"
}

# Command line interface

usage () {
  echo "$0 [get|set PREF|toggle]"
}

cmdline () {
  if [ $# = 0 ]; then return 1; fi

  case "$1" in
    "get") get_xkb_pref ;;
    "set") set_xkb_pref "$2" ;;
    "toggle") toggle_xkb_pref ;;
    "*") return 1
  esac
}

# Main entry point

cmdline "$@" || usage
