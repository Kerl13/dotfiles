#!/bin/sh

set -euC

# The global state is stored in $RUNTIME_VAR.
# Do not edit this file manually

RUNTIME_DIR="$HOME/.local/var/lib"
RUNTIME_VAR="$RUNTIME_DIR/xkb_current"

# Library functions

set_xkb_pref () {
  setxkbmap fr oss
  setxkbmap -option  # reset all options
  killall xcape 2>/dev/null || true
  case "$1" in
    "custom")
      setxkbmap -option 'caps:escape'
      # Shift+! = \
      xmodmap -e 'keycode 61 = exclam backslash exclam backslash exclamdown U2212 exclamdown U2212'
      # Set Mode_switch / Escape / Control_L
      xmodmap -e 'keycode 49 = Mode_switch NoSymbol Mode_switch' # Menu
      xmodmap -e 'keycode 135 = Mode_switch NoSymbol Mode_switch' # Â²
      xmodmap -e 'keycode 9 = Mode_switch NoSymbol Mode_switch' # escape
      # Remap Mod_switch + ui to Page{Down,Up}
      xmodmap -e 'keycode  30 = u U Next Next ucircumflex Ucircumflex ucircumflex Ucircumflex u U ucircumflex Ucircumflex u U ucircumflex Ucircumflex'
      xmodmap -e 'keycode  31 = i I Prior Prior icircumflex Icircumflex icircumflex Icircumflex i I icircumflex Icircumflex i I icircumflex Icircumflex'
      # Remap Mode_switch + hjkl to arrow keys
      xmodmap -e 'keycode 43 = h H Left Left eth ETH eth ETH'
      xmodmap -e 'keycode 44 = j J Down Down udiaeresis Udiaeresis udiaeresis Udiaeresis'
      xmodmap -e 'keycode 45 = k K Up Up idiaeresis Idiaeresis idiaeresis Idiaeresis'
      xmodmap -e 'keycode 46 = l L Right Right U0140 U013F U0140 U013F'
      # Mode_switch + Backspace = Delete
      xmodmap -e 'keycode  22 = BackSpace BackSpace Delete Delete BackSpace BackSpace'
      # Mode + number = Function keys
      xmodmap -e 'keycode 10 = ampersand 1 F1 1 dead_caron dead_ogonek dead_caron dead_ogonek ampersand 1 dead_caron dead_ogonek ampersand 1 dead_caron dead_ogonek'
      xmodmap -e 'keycode 11 = eacute 2 F2 2 asciitilde Eacute asciitilde Eacute eacute 2 asciitilde Eacute eacute 2 asciitilde Eacute'
      xmodmap -e 'keycode 12 = quotedbl 3 F3 3 numbersign dead_breve numbersign dead_breve quotedbl 3 numbersign dead_breve quotedbl 3 numbersign dead_breve'
      xmodmap -e 'keycode 13 = apostrophe 4 F4 4 braceleft U2014 braceleft U2014 apostrophe 4 braceleft U2014 apostrophe 4 braceleft U2014'
      xmodmap -e 'keycode 14 = parenleft 5 F5 5 bracketleft U2013 bracketleft U2013 parenleft 5 bracketleft U2013 parenleft 5 bracketleft U2013'
      xmodmap -e 'keycode 15 = minus 6 F6 6 bar U2011 bar U2011 minus 6 bar U2011 minus 6 bar U2011'
      xmodmap -e 'keycode 16 = egrave 7 F7 7 grave Egrave grave Egrave egrave 7 grave Egrave egrave 7 grave Egrave'
      xmodmap -e 'keycode 17 = underscore 8 F8 8 backslash trademark backslash trademark underscore 8 backslash trademark underscore 8 backslash trademark'
      xmodmap -e 'keycode 18 = ccedilla 9 F9 9 asciicircum Ccedilla asciicircum Ccedilla ccedilla 9 asciicircum Ccedilla ccedilla 9 asciicircum Ccedilla'
      xmodmap -e 'keycode 19 = agrave 0 F10 0 at Agrave at Agrave agrave 0 at Agrave agrave 0 at Agrave'
      xmodmap -e 'keycode 20 = parenright degree F11 degree bracketright notequal bracketright notequal parenright degree bracketright notequal parenright degree bracketright notequal'
      xmodmap -e 'keycode 21 = equal plus F12 plus braceright plusminus braceright plusminus equal plus braceright plusminus equal plus braceright plusminus'
      # TODO: VT console switch
      ;;
    "fr oss")
      ;;
    "*")
      echo "Invalid xkb_pref: $1"
      exit 1
  esac
  mkdir -p "$RUNTIME_DIR"
  echo "$1" >| "$RUNTIME_VAR"
  echo "Keyboard layout set to '$1'"
}

get_xkb_pref () {
  if [ -f "$RUNTIME_VAR" ]; then
    cat "$RUNTIME_VAR"
  else
    echo "undef"
  fi
}

next_xkb_pref () {
  case "$(get_xkb_pref)" in
    "custom") echo "fr oss" ;;
    "fr oss") echo "custom" ;;
    "*") echo "custom";;
  esac
}

toggle_xkb_pref () {
  set_xkb_pref "$(next_xkb_pref "$(get_xkb_pref)")"
}

# Command line interface

usage () {
  echo "$0 [get|set PREF|toggle]"
}

cmdline () {
  if [ $# = 0 ]; then return 1; fi

  case "$1" in
    "get") get_xkb_pref ;;
    "set") set_xkb_pref "$2" ;;
    "toggle") toggle_xkb_pref ;;
    "*") return 1
  esac
}

# Main entry point

cmdline "$@" || usage
